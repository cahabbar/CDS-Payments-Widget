import java.util.UUID
def shellCommandOutput(command) {
    def uuid = UUID.randomUUID()
    def filename = "cmd-${uuid}"
    echo filename
    sh ("${command} > ${filename}")
    def result = readFile(filename).trim()
    sh "rm ${filename}"
    return result
}

pipeline {
    agent any

    // Get the Terraform tool.
    def tfHome = tool name: 'Terraform', type: 'com.cloudbees.jenkins.plugins.customtools.CustomTool'
    env.PATH = "${tfHome}:${env.PATH}"

    environment {
        AWS_PROFILE = shellCommandOutput("aws iam list-account-aliases | jq .AccountAliases[0]")
    }
    parameters {
        choice choices: ['us-east1'], description: '', name: 'AWS_REGION'
    }
    wrap([$class: 'AnsiColorBuildWrapper', colorMapName: 'xterm']) {
        stages {
            stage('Plan') {
                steps {
                    sh "terraform --version"
                    sh "terraform --version"
                }
            }
            stage('Test') {
                steps {
                    echo 'Testing..'
                }
            }
            stage('Deploy') {
                steps {
                    echo 'Deploying....'
                }
            }
        }
    }
}